services:
    rabbitmq:
        image: rabbitmq:3-management-alpine
        container_name: "rabbitmq"
        ports:
            - 5672:5672
            - 15672:15672
        volumes:
            - ~/.docker-conf/rabbitmq/data/:/var/lib/rabbitmq/
            - ~/.docker-conf/rabbitmq/log/:/var/log/rabbitmq
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:15672"]
            interval: 30s
            timeout: 10s
            retries: 5
        networks:
            - rabbitmq_nodejs

    queue-producer:
        build:
            context: .
            dockerfile: Dockerfile
        volumes:
            - .:/src
        ports:
            - "3001:3001"
        depends_on:
            - "rabbitmq"
        command: sh -c './wait-for-it.sh rabbitmq:5672 --timeout=30 -- npm run dev'
        environment:
            NODE_ENV: production
            AMQP_URL: amqp://guest:guest@rabbitmq:5672
        networks:
            - rabbitmq_nodejs

networks:
    rabbitmq_nodejs:
        driver: bridge
